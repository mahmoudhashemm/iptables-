ุชูุงู โุ ุฎูููุง ูุนูููุง ุจุงูุฑุงุญุฉ:

---

## ๐ฏ ุงููุฏู

ุชููู ุฃู **ุฎุฑูุฌ ููุฅูุชุฑูุช (outbound)** ูู ุงูุญุงููุงุช ุงููู ูู ุฑููุฌ:

```
10.0.0.0/8
```

ูุนูู ูู IP ูุจุฏุฃ ุจู `10.` (ุฒู: 10.0.0.202, 10.0.0.203โฆ ุฅูุฎ).

---

## ๐๏ธ ุงููุงุนุฏุฉ ูู iptables

ุนูู ุงูุณูุฑูุฑ (Ubuntu host):

```bash
iptables -I DOCKER-USER -s 10.0.0.0/8 -o eth0 -j DROP
```

### ูุนูู ุงููุงุนุฏุฉ:

* `-s 10.0.0.0/8` = ุฃู ุญุงููุฉ IPูุง ูุจุฏุฃ ุจู 10.*.*.\*
* `-o eth0` = ุชุญุงูู ุชุฎุฑุฌ ุนูู ุงูุฅูุชุฑูุช ูู ุงูุฅูุชุฑููุณ ุงูุฎุงุฑุฌู.
* `-j DROP` = ูุชููุน.

---

## ๐ ููุชุญูู

ุดูู ุงููุงุนุฏุฉ ุงูุถุงูุช:

```bash
iptables -L DOCKER-USER -n --line-numbers
```

---

## ๐พ ููุญูุธ ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู

```bash
netfilter-persistent save
```

ุฃู:

```bash
iptables-save > /etc/iptables/rules.v4
```

---

## ๐ ููุงุญุธุงุช

* ูุฏู ุฃู ุญุงููุฉ ุฌูู ุฑููุฌ 10.0.0.0/8 ูุด ูุชุทูุน ุฅูุชุฑูุช.
* ุจุณ ูุณู ููุฏุฑูุง ูุชูุงุตููุง ุฏุงุฎูููุง ุจูู ุจุนุถ (ุฏุงุฎู ููุณ ุดุจูุฉ Docker).
* ูู ุนุงูุฒ ุชุนูู ุงุณุชุซูุงุก (ูุซูุงู Odoo ูุทูุน ุนูู 443) ูุงุฒู ุชุถูู ูุงุนุฏุฉ ุณูุงุญ ูุจู ูุงุนุฏุฉ ุงูู DROP.

---

ุชุญุจ ุฃุฌูุฒูู ุณูุฑุจุช ููู:

* ููู ุงููุช ุนู 10.0.0.0/8 ุจุงููุงูู.
* ูุน ุฅููุงููุฉ ุฅุถุงูุฉ ุงุณุชุซูุงุกุงุช (ุจูุฑุชุงุช ุฃู ุญุงููุงุช ูุญุฏุฏุฉ)ุ







ุชูุงู โุ ุฎูููู ุฃุฏูู ููุฎุต ููุงุฆู ูุฑุชุจ ุชูุฏุฑ ุชุญูุธู ูู **Documentation** ุนูุฏู:

---








ุชูุงู โ ุฏู **ููุฎุต ูุฎุชุตุฑ ูุญุงุณู** ููู ุนูููุงู ุนูุดุงู ุชุญูุธู ุนูุฏู ๐

---

# ๐ฏ ุงููุฏู

* ููู **ุฎุฑูุฌ** ูู ุงูุญุงููุงุช ููุฅูุชุฑูุช (Outbound).
* ุงูุณูุงุญ ููุท ูุดุจูุฉ **Mailcow** ุจุงูุฎุฑูุฌ ุนูู ุงูููุงูุฐ ุงูุถุฑูุฑูุฉ.
* ุฅุจูุงุก **ุงูุฏุฎูู** ูุฎุฏูุงุชู ุงูููุดูุฑุฉ (Portainer ุนูู 9505ุ Odoo ุนูู 8069/8072) ุดุบุงู ุทุจูุนู.

---

# ๐งฉ ุงููุดููุฉ ุงููู ุธูุฑุช

* ุฅุถุงูุฉ ูุงุนุฏุฉ **DROP ุนุงูุฉ** ูู `DOCKER-USER` ูุณูุฑุช Portainer (ูุงูุงุชุตุงูุงุช ุงูุฑุงุฌุนุฉ).
* ููุงู Portainer ูุง ูุชุญุด ูุฃู ุงูุณูุงุญ ูุงู ูู `DOCKER-USER` ุจุฏู ูุง ูููู ูู **INPUT** (ุงูุฏุฎูู ูู ุงูุฅูุชุฑูุช).

**ุงูุนูุงุฌ:**

* ุฅุถุงูุฉ ูุงุนุฏุฉ **ESTABLISHED,RELATED** ุฃูู `DOCKER-USER` ููุณูุงุญ ุจุงูู replies.
* ููู/ุฅุถุงูุฉ ุงูุณูุงุญ ูู 9505/8069/8072 ูู **INPUT** (ุฏุฎูู)ุ ูุด ูู `DOCKER-USER`.

---

# โ ุงูุญุงูุฉ ุงูููุงุฆูุฉ (ุงูููุทู ุงููุนูุงู)

**DOCKER-USER (ููุฎุฑูุฌ ููุท):**

```bash
# 1) ุงุณูุญ ุจุฑุฏูุฏ ุงูุฌูุณุงุช ุงููุงุฆูุฉ (ููู ุฌุฏูุง)
iptables -I DOCKER-USER 1 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 2) Mailcow subnet ููุท (ูุซุงู: 172.22.1.0/24) ุชุฎุฑุฌ ุนูู ุงูููุงูุฐ ุงูุถุฑูุฑูุฉ
iptables -I DOCKER-USER 2 -s 172.22.1.0/24 -o eth0 -p udp --dport 53 -j ACCEPT
iptables -I DOCKER-USER 3 -s 172.22.1.0/24 -o eth0 -p tcp --dport 53 -j ACCEPT
iptables -I DOCKER-USER 4 -s 172.22.1.0/24 -o eth0 -p tcp -m multiport --dports 25,465,587,443 -j ACCEPT

# 3) ููู ุฎุฑูุฌ ุจุงูู ุงูุญุงููุงุช
iptables -A DOCKER-USER -o eth0 -j DROP
```

> ููุงุญุธุฉ: ุงูุณูุงุญ ูู **9505** ุฏุงุฎู `DOCKER-USER` **ูุด ูุงุฒู**ุ ุฏู ูุชุญูู ููู ูู INPUT (ุฏุฎูู).

**INPUT (ููุฏุฎูู ูู ุงูุฅูุชุฑูุช ููุณูุฑูุฑ):**

```bash
# Portainer
iptables -I INPUT 1 -p tcp --dport 9505 -j ACCEPT
# Odoo
iptables -I INPUT 1 -p tcp --dport 8069 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 8072 -j ACCEPT
# (ุงุฎุชูุงุฑู) ูุตูุฑูุง ุนูู IP ูุนููู:
# iptables -I INPUT 1 -p tcp -s <YOUR_IP> --dport 9505 -j ACCEPT
```

---

# ๐ ุงูุชุญูู ุงูุณุฑูุน

```bash
# ุฑุงุฌุน ุงูููุงุนุฏ ูุงูุนุฏุงุฏุงุช
iptables -L DOCKER-USER -n -v --line-numbers
iptables -L INPUT -n -v --line-numbers

# ุชุฃูุฏ Portainer ุดุบุงู ูุญูููุง
ss -tlnp | grep 9505
curl -I http://localhost:9505
```

* ูู ุญุงููุฉ ุบูุฑ ูุณููุญ ููุง ุฌุฑูุจ:

  ```bash
  docker exec -it <ctr> curl -I https://www.google.com  # ุงูููุฑูุถ ููุดู
  ```
* ูู ุญุงููุฉ Mailcow ุฌุฑูุจ 443/53/25/465/587 โ ุชุนูู.

---

# ๐พ ุญูุธ ุงูููุงุนุฏ

```bash
netfilter-persistent save
# ุฃู
iptables-save > /etc/iptables/rules.v4
```

---

# ๐ ููุงุญุธุงุช ูููุฉ

* ูุงุนุฏุฉ `ESTABLISHED,RELATED` **ุขููุฉ ููุง ุชูุชุญ ููุงูุฐ**ุ ุจุชุณูุญ ุจุงูู replies ููุท.
* **ุชุฌููุจ** `DROP all` ุจุฏูู `-o eth0` ูุฃูู ููุณุฑ ุงูุฏุฎูู ููุฎุฏูุงุช ุงูููุดูุฑุฉ.
* ูู ุนูุฏู **Cloud Firewall** ุนูุฏ ุงููุฒููุฏุ ุงูุชุญ 9505/8069/8072/443 ููุงู ุฃูุถูุง.

---

ุฏู ุงูููุฎุต ุงูุชูููุฐู: **Whitelist ูุฎุฑูุฌ Mailcow ููุท + DROP ููุฎุฑูุฌ ููุจุงูู + INPUT ุณูุงุญ ูุจูุฑุชุงุช Portainer/Odoo + ูุงุนุฏุฉ ESTABLISHED ุฃูู DOCKER-USER**.
