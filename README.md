تمام ✅، خلينا نعملها بالراحة:

---

## 🎯 الهدف

تقفل أي **خروج للإنترنت (outbound)** من الحاويات اللي في رينج:

```
10.0.0.0/8
```

يعني كل IP يبدأ بـ `10.` (زي: 10.0.0.202, 10.0.0.203… إلخ).

---

## 🛠️ القاعدة في iptables

على السيرفر (Ubuntu host):

```bash
iptables -I DOCKER-USER -s 10.0.0.0/8 -o eth0 -j DROP
```

### معنى القاعدة:

* `-s 10.0.0.0/8` = أي حاوية IPها يبدأ بـ 10.*.*.\*
* `-o eth0` = تحاول تخرج على الإنترنت من الإنترفيس الخارجي.
* `-j DROP` = يتمنع.

---

## 🔍 للتحقق

شوف القاعدة انضافت:

```bash
iptables -L DOCKER-USER -n --line-numbers
```

---

## 💾 للحفظ بعد إعادة التشغيل

```bash
netfilter-persistent save
```

أو:

```bash
iptables-save > /etc/iptables/rules.v4
```

---

## 📌 ملاحظات

* كده أي حاوية جوه رينج 10.0.0.0/8 مش هتطلع إنترنت.
* بس لسه يقدروا يتواصلوا داخليًا بين بعض (داخل نفس شبكة Docker).
* لو عايز تعمل استثناء (مثلاً Odoo يطلع على 443) لازم تضيف قاعدة سماح قبل قاعدة الـ DROP.

---

تحب أجهزلك سكربت فيه:

* قفل النت عن 10.0.0.0/8 بالكامل.
* مع إمكانية إضافة استثناءات (بورتات أو حاويات محددة)؟







تمام ✅، خليني أديك ملخص نهائي مرتب تقدر تحفظه كـ **Documentation** عندك:

---

# 📌 ملخص إعدادات iptables لتأمين الحاويات + Mailcow

## 🎯 الهدف

* السماح فقط لحاويات Mailcow بالخروج للإنترنت على البورتات الضرورية.
* منع كل الحاويات التانية (Odoo, DB, …) من الوصول للإنترنت.
* إبقاء الدخول (Inbound) للخدمات زي Portainer, Odoo, Mailcow GUI شغال عادي.

---

## 🛠️ القواعد الفعالة حاليًا (DOCKER-USER chain)

### 1. Mailcow Subnet (`172.22.1.0/24`)

يسمح بالخروج على:

```bash
ACCEPT tcp  -- 172.22.1.0/24  0.0.0.0/0  tcp dpt:443            # HTTPS
ACCEPT tcp  -- 172.22.1.0/24  0.0.0.0/0  multiport dports 25,465,587   # SMTP
ACCEPT tcp  -- 172.22.1.0/24  0.0.0.0/0  tcp dpt:53             # DNS (TCP)
ACCEPT udp  -- 172.22.1.0/24  0.0.0.0/0  udp dpt:53             # DNS (UDP)
```

### 2. Fail2Ban (SSH protection)

```bash
f2b-sshd   tcp  -- 0.0.0.0/0  0.0.0.0/0  multiport dports 22
```

### 3. Ping (اختياري للمراقبة)

```bash
ACCEPT icmp -- 0.0.0.0/0  0.0.0.0/0
```

### 4. قفل خروج باقي الحاويات

```bash
DROP all -- docker0 eth0  0.0.0.0/0  0.0.0.0/0   # منع أي ترافيك من docker0 إلى الإنترنت
DROP all -- * eth0        0.0.0.0/0  0.0.0.0/0   # Safety net: منع أي ترافيك للخارج لم يُسمح به
```

---

## ✅ النتيجة

* Mailcow يشتغل طبيعي (DNS + SMTP + HTTPS).
* باقي الحاويات **مقفولة إنترنت**.
* الدخول على بورتات الخدمات (Portainer 9505, Odoo 8069, Mailcow 443) شغال عادي.
* الحماية من brute force على SSH شغالة (Fail2Ban).

---

## 💾 للحفظ بعد إعادة التشغيل

```bash
netfilter-persistent save
```

أو:

```bash
iptables-save > /etc/iptables/rules.v4
```

---

تحب أجهزلك نسخة **سكريبت bash** فيها القواعد دي كلها (ready-to-run) بحيث لو السيرفر وقع أو rebooted ترجعها بكليك واحد؟
